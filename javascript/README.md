# Javascript

## 이벤트 루프

자바스크립트는 **단일 스레드** 언어이기 때문에 동시에 하나의 작업만을 처리할 수 있다. 하지만 우리는 자바스크립트를 사용하면서 여러 개의 애니메이션 효과를 보여주면서 이벤트를 처리하기도 하고, HTTP 요청을 처리하는 등 동시에 여러가지 작업을 할 수 있다. 이처럼 자바스크립트의 동시성을 지원해 주는 것이 **이벤트 루프** 이며, 이벤트 루프는 **자바스크립트가 아닌 자바스크립트를 실행하는 환경인 브라우저나 Node.js에서 제공된다.**

### 콜 스택과(Call Stack) 힙(Heap)

대부분의 자바스크립트 엔진은 **콜 스택**과 **힙**으로 이루어져 있다.

* 콜 스택
  * 함수 호출의 실행 컨텍스트가 저장되는 곳이다.
  * 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행된다. 만약 함수의 종료문에 다다를 경우 해당 함수의 실행 컨텍스트는 콜 스택에서 제거(POP) 된다.

> 실행 컨텍스트에 대한 자세한 내용은 추후 실행 컨텍스트에 대해 정리할 때 추가적으로 알아보도록 하겠다. (아직 미완)

* 힙
  * 객체와 같이 할당해야할 메모리 공간의 크기가 런타임에 결정(동적 할당) 되는 값을 저장하는 곳이다.
  * 따라서 힙은 구조화되어 있지 않다는 특징이 있다.

콜 스택과 힙으로 구성되어 있는 자바스크립트 엔진은 **단순히 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행**할 뿐이다. 비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 Node.js가 담당한다. 이를 처리하기 위해 브라우저 환경은 태스크 큐와 이벤트 루프를 제공한다.



### 태스크 큐 (Task Queue)

`setTimeout` ,`setInterval` 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역이다. 별도로 마이크로태스크 큐도 존재한다.



### 마이크로태스크 큐 (MicroTask Queue)

Promise의 후속 처리 메서드의 콜백 함수 (`Promise.then` 등) 가 일시적으로 보관되는 영역이다. **이벤트 루프는 태스크 큐를 확인하기 전에 마이크로태스크  큐를 먼저 확인하고 이를 처리한다.**



### 이벤트 루프

이벤트 루프는 콜 스택에 현재 실행중인 함수가 있는지, 그리고 태스크 큐에 대기 중인 함수(콜백 함수, 이벤트 핸들러 등) 이 있는지 반복해서 확인한다. **만약 콜 스택이 비어있고, 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 순차적으로 태스크 큐에 있는 함수를 콜 스택으로 이동시키고 실행한다.** 이를 통해 우리는 단일스레드 언어인 자바스크립트 환경에서 비동기 처리 방식을 사용할 수 있다.



### 코드로 보는 예제

```javascript
console.log('script start'); 

setTimeout(function() {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(function() {
  console.log('promise then');
});

console.log('script end');
```

1. `console.log('script start'); ` 태스크가 콜 스택에 들어가 실행된다.
2. `console.log('setTimeout');` 태스크가 태스크 큐에 들어가게 된다.
3. `console.log('promise then');` 태스크가 마이크로태스크 큐에 들어가게 된다.
4. `console.log('script end');` 태스크가 콜 스택에 들어가 실행된다.
5. 콜 스택이 비어있기 때문에 이벤트 루프는 마이크로 태스크 큐를 확인하고 `  console.log('promise then');` 태스크를 콜스택에 푸시하고 실행한다.
6. 콜 스택이 비어있고 마이크로태스크 큐가 비어있기 때문에 이벤트 루프는 태스크 큐를 확인하고 `console.log('setTimeout');` 태스크를 콜스택에 푸시하고 실행한다.



따라서 콘솔에 출력되는 값은 다음과 같다.

```javascript
script start
script end
promise1
setTimeout
```



### 참고한 내용

 모던 자바스크립트 Deep Dive 42장 비동기 프로그래밍

[자바스크립트와 이벤트 루프](https://meetup.toast.com/posts/89)

[어쨌든 이벤트 루프는 무엇입니까? 유튜브 영상](https://www.youtube.com/watch?v=8aGhZQkoFbQ)



